{% extends 'base.html' %}

{% block title %}Session Details - {{ session.unit.code }}{% endblock %}

{% block extra_css %}
<style>
    .creation-banner {
        background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 255, 242, 0.2));
        border: 2px solid var(--success);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        animation: slideIn 0.5s ease-out;
    }

    .creation-banner svg {
        width: 24px;
        height: 24px;
        stroke: var(--success);
        flex-shrink: 0;
    }

    .creation-banner-text {
        color: var(--success);
        font-size: 0.95rem;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .detail-container {
        padding: 2rem;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        margin-bottom: 2rem;
        transition: color 0.3s ease;
    }

    .back-link:hover {
        color: var(--primary-cyan);
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr minmax(260px, 380px);
        gap: 1.25rem;
        align-items: start;
    }

    .session-info-card {
        padding: 2rem;
    }

    .info-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--glass-border);
    }

    .unit-code {
        font-family: 'Orbitron', monospace;
        font-size: 2rem;
        color: var(--primary-cyan);
        margin-bottom: 0.5rem;
    }

    .unit-name {
        font-size: 1.2rem;
        color: var(--text-primary);
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .status-active {
        background: rgba(0, 255, 136, 0.2);
        color: var(--success);
        border: 1px solid var(--success);
    }

    .status-closed {
        background: rgba(255, 51, 102, 0.2);
        color: var(--error);
        border: 1px solid var(--error);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .info-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 1.25rem;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
    }

    .info-item-label {
        font-size: 0.75rem;
        color: var(--primary-cyan);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
        font-family: 'Share Tech Mono', monospace;
    }

    .info-item-value {
        font-size: 1.1rem;
        color: var(--text-primary);
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .qr-card {
        padding: 2rem;
        text-align: center;
        position: sticky;
        top: 2rem;
    }

    .qr-title {
        font-family: 'Share Tech Mono', monospace;
        font-size: 1rem;
        color: var(--primary-cyan);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 1.5rem;
    }

    .qr-container {
        background: white;
        padding: 1rem;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        display: inline-block;
        box-shadow: 0 0 30px rgba(0, 255, 242, 0.3);
    }

    .qr-container img {
        max-width: 100%;
        height: auto;
        display: block;
    }

    .qr-placeholder {
        width: 100%;
        padding-top: 100%; /* 1:1 aspect ratio */
        position: relative;
        background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
        display: block;
        color: #666;
        font-size: 0.9rem;
    }
    .qr-placeholder::after {
        content: attr(data-label);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .qr-url {
        font-family: 'Share Tech Mono', monospace;
        font-size: 0.75rem;
        color: var(--text-secondary);
        word-break: break-all;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
    }

    .attendance-section {
        margin-top: 1rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title::before {
        content: '';
        width: 4px;
        height: 20px;
        background: linear-gradient(180deg, var(--primary-cyan), var(--primary-purple));
        border-radius: 2px;
    }

    .count-badge {
        background: rgba(0, 255, 242, 0.2);
        color: var(--primary-cyan);
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-family: 'Orbitron', monospace;
    }

    .attendance-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    .attendance-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 480px; /* allow horizontal scroll on very small screens */
    }

    .attendance-table th,
    .attendance-table td {
        padding: 0.75rem 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--glass-border);
        vertical-align: middle;
        word-break: break-word;
    }

    .attendance-table th {
        font-family: 'Share Tech Mono', monospace;
        font-size: 0.8rem;
        color: var(--primary-cyan);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .attendance-table tr:hover {
        background: rgba(0, 255, 242, 0.05);
    }

    .empty-attendance {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .empty-attendance svg {
        width: 60px;
        height: 60px;
        stroke: var(--glass-border);
        margin-bottom: 1rem;
    }

    .refresh-indicator {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 1rem;
    }

    .refresh-indicator.updating {
        color: var(--primary-cyan);
    }

    @media (max-width: 1024px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }

        .qr-card {
            order: -1;
            position: relative;
            top: auto;
            margin-bottom: 1rem;
        }
    }

    @media (max-width: 600px) {
        .info-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }

        .creation-banner {
            flex-direction: column;
            text-align: center;
        }

        .btn {
            width: 100%;
        }

        .unit-code { font-size: 1.4rem; }
        .unit-name { font-size: 1rem; }
        .qr-container { max-width: 320px; margin: 0 auto; }
    }

    @media (max-width: 420px) {
        .info-item { padding: 0.9rem; }
        .attendance-table th, .attendance-table td { padding: 0.5rem; font-size: 0.9rem; }
        .qr-container img { max-width: 260px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container detail-container">
    <a href="{% url 'dashboard' %}" class="back-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
        </svg>
        Back to Dashboard
    </a>

    <!-- Success Banner if Session Just Created -->
    {% if messages %}
        <div class="creation-banner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <div class="creation-banner-text">
                ‚úì Session created successfully! QR code generated. Share this QR code with students to mark attendance.
            </div>
        </div>
    {% endif %}

    <div class="detail-grid">
        <div class="glass-card session-info-card">
            <div class="info-header">
                <div>
                    <div class="unit-code">{{ session.unit.code }}{% if session.session_number %} - S{{ session.semester }} Lec {{ session.session_number }}{% endif %}</div>
                    <div class="unit-name">{{ session.unit.name }}</div>
                </div>
                <span class="status-badge {% if session.is_active %}status-active{% else %}status-closed{% endif %}">
                    {% if session.is_active %}Active{% else %}Closed{% endif %}
                </span>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-item-label">Lecturer</div>
                    <div class="info-item-value">{{ session.lecturer_name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">Class</div>
                    <div class="info-item-value">{{ session.class_year }}</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">Date</div>
                    <div class="info-item-value">{{ session.date|date:"l, M d, Y" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">Time</div>
                    <div class="info-item-value">{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">Venue</div>
                    <div class="info-item-value">{{ session.venue }}</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">Semester</div>
                    <div class="info-item-value">S{{ session.semester }}</div>
                </div>
            </div>

            <div class="action-buttons">
                <a href="{% url 'toggle_session' session.id %}" class="btn {% if session.is_active %}btn-danger{% else %}btn-primary{% endif %}">
                    {% if session.is_active %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    Close Session
                    {% else %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 16 16 12 12 8 8 12 12 16"/>
                    </svg>
                    Reopen Session
                    {% endif %}
                </a>
                <a href="{% url 'download_qr' session.id %}" class="btn btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download QR
                </a>
            </div>

            <div class="attendance-section glass-card" style="margin-top: 2rem; padding: 1.5rem; margin-left: -1.5rem; margin-right: -1.5rem; margin-bottom: -1.5rem;">
                <div class="section-header">
                    <div class="section-title">üìä Real-time Attendance</div>
                    <span class="count-badge"><span id="attendance-count">{{ attendance_count }}</span> students</span>
                </div>
                
                {% if attendance_records %}
                <div style="overflow-x: auto;">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Admission</th>
                                <th>Student Name</th>
                                <th>Timestamp</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-body">
                            {% for record in attendance_records %}
                            <tr>
                                <td><code>{{ record.admission_number }}</code></td>
                                <td><strong>{{ record.student_name }}</strong></td>
                                <td><small>{{ record.timestamp|slice:"-8:" }}</small></td>
                                <td><strong>{{ record.attendance_percentage|floatformat:1 }}%</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="refresh-indicator" id="refresh-status">
                    ‚ôªÔ∏è Auto-refreshing every 3 seconds...
                </div>
                {% else %}
                <div class="glass-card empty-attendance">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <line x1="19" y1="8" x2="19" y2="14"/>
                        <line x1="22" y1="11" x2="16" y2="11"/>
                    </svg>
                    <p>No attendance records yet</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">Students will appear here as they scan the QR code</p>
                </div>
                {% endif %}
            </div>

            <div class="glass-card students-card" style="margin-top: 1rem;">
                <div class="section-header">
                    <div class="section-title">üë• Enrolled Students</div>
                    <span class="count-badge"><span id="enrolled-count">{{ enrolled_students|length }}</span> students</span>
                </div>
                <div style="overflow-x:auto;">
                    <ul id="enrolled-list" style="list-style:none; padding-left:0; margin:0;">
                        {% for student in enrolled_students %}
                        <li data-adm="{{ student.admission_number }}" style="padding: .4rem 0; border-bottom: 1px dashed var(--muted); display:flex; justify-content:space-between; align-items:center;">
                            <div><strong>{{ student.name }}</strong> <small style="color:var(--text-secondary);">({{ student.admission_number }})</small></div>
                            <div class="present-badge">{% if student.admission_number in attending_admissions %}<span class="badge badge-success">Present</span>{% else %}<span class="badge badge-light">‚Äî</span>{% endif %}</div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="glass-card qr-card">
            <div class="qr-title">üì± QR Code</div>
            <div class="qr-container">
                {% if session.qr_code %}
                {# Use the download view as the image source so the QR image is served
                   by Django even when MEDIA static serving is disabled in production. #}
                <img src="{% url 'download_qr' session.id %}" alt="QR Code for {{ session.unit.code }}">
                {% else %}
                <div class="qr-placeholder">QR Code not generated</div>
                {% endif %}
            </div>
            <div class="qr-url">
                {{ request.scheme }}://{{ request.get_host }}/attend/{{ session.id }}/
            </div>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                ‚úì Students scan this QR code to mark attendance instantly
            </p>
            <a href="{% url 'download_qr' session.id %}?download=1" class="btn btn-primary" style="width: 100%;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Download QR Code
            </a>
        </div>
    </div>
</div>

<script>
// Auto-refresh attendance data every 3 seconds
const sessionId = "{{ session.id }}";
let refreshInterval;

function refreshAttendance() {
    fetch(`/api/status/?session_id=${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.attendance_count !== undefined) {
                document.getElementById('attendance-count').textContent = data.attendance_count;
            }
            // Update the attendance list table body
            if (Array.isArray(data.attendance_records)) {
                const tbody = document.getElementById('attendance-body');
                if (tbody) {
                    tbody.innerHTML = '';
                    if (data.attendance_records.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="4" style="text-align:center;color:var(--text-secondary);">No attendance records yet</td>`;
                        tbody.appendChild(tr);
                    } else {
                        data.attendance_records.forEach(rec => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><code>${rec.admission_number || ''}</code></td>
                                <td><strong>${rec.student_name || ''}</strong></td>
                                <td><small>${rec.timestamp ? rec.timestamp.slice(-8) : ''}</small></td>
                                <td><strong>${(rec.attendance_percentage || 0).toFixed(1)}%</strong></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                }
            }

            // Update enrolled student presence badges
            try {
                if (Array.isArray(data.attendance_records)) {
                    const present = new Set(data.attendance_records.map(r => r.admission_number));
                    const enrolledList = document.getElementById('enrolled-list');
                    if (enrolledList) {
                        Array.from(enrolledList.querySelectorAll('li')).forEach(li => {
                            const adm = li.getAttribute('data-adm');
                            const badge = li.querySelector('.present-badge');
                            if (!badge) return;
                            if (present.has(adm)) {
                                badge.innerHTML = '<span class="badge badge-success">Present</span>';
                            } else {
                                badge.innerHTML = '<span class="badge badge-light">‚Äî</span>';
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('Failed to update enrolled presence', e);
            }

            // Visual feedback that we're updating (timestamped)
            const indicator = document.getElementById('refresh-status');
            if (indicator) {
                indicator.classList.add('updating');
                indicator.textContent = '‚ôªÔ∏è Updated ' + new Date().toLocaleTimeString();
                setTimeout(() => indicator.classList.remove('updating'), 500);
            }
        })
        .catch(err => {
            const indicator = document.getElementById('refresh-status');
            if (indicator) {
                indicator.classList.remove('updating');
                indicator.textContent = '‚ö†Ô∏è Network error ‚Äî could not fetch attendance. Please check the server.';
            }
            console.error('Attendance refresh failed', err);
        });
}

// Start auto-refresh
refreshInterval = setInterval(refreshAttendance, 3000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
});
</script>
{% endblock %}




